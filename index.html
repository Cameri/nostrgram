<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css?v=13" />
    <title>Nostrgram</title>
    <script src="https://bitcoincore.tech/apps/bitcoinjs-ui/lib/bitcoinjs-lib.js"></script>
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
</head>

<body>
    <!-- based on this: https://github.com/YunusEmreNalbant/css-chat-interface -->
    <script>
        var { getSharedSecret, schnorr, utils } = nobleSecp256k1
        var crypto  = window.crypto 
        var getRand = size => crypto.getRandomValues(new Uint8Array(size))
        var sha256  = bitcoinjs.crypto.sha256
        if ( localStorage[ "backup" ] ) {
            var backup = JSON.parse( localStorage[ "backup" ] );
            var privKey = backup[ "privkey" ];
            var pubKey = backup[ "pubkey" ];
            var subscribed_channels = JSON.parse( backup[ "channels" ] );
            var relay = JSON.parse( backup[ "relays" ] )[ 0 ];
        } else {
            var keypair = bitcoinjs.ECPair.makeRandom()
            var privKey = keypair.privateKey.toString( "hex" )
            var pubKey  = keypair.publicKey.toString( "hex" )
            pubKey      = pubKey.substring( 2 )
            var subscribed_channels = [ "f06a690997a1b7d8283c90a7224eb8b7fe96b7c3d3d8cc7b2e7f743532c02b42" ];
            var relay = "wss://relay.damus.io";
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
        }
        var array_of_pubkeys = [];
        var namemap = {}
        var socket = new WebSocket( relay );
        socket.addEventListener('message', async function( message ) {
            var [ type, subId, event ] = JSON.parse( message.data );
            var { kind, content } = event || {}
            if ( subId.startsWith( "00000001" ) ) {
                if ( content && !checkForUserMetaErrors( content ) ) {
                    if ( "name" in JSON.parse( content ) && !( !JSON.parse( content )[ "name" ] || JSON.parse( content )[ "name" ] == "" ) ) {
                        namemap[ event.pubkey ] = JSON.parse( content )[ "name" ];
                        var i; for ( i=0; i<document.getElementsByClassName( event.pubkey ).length; i++ ) {
                            document.getElementsByClassName( event.pubkey )[ i ].innerText = JSON.parse( content )[ "name" ];
                        }
                    } else {
                        namemap[ event.pubkey ] = "none";
                    }
                } else if ( content && checkForUserMetaErrors( content ) ) {
                    namemap[ event.pubkey ] = "none";
                }
                var closer = [ "CLOSE", subId ];
                socket.send(JSON.stringify( closer ));
            }
            if ( kind && subId.startsWith( "00000000" ) ) {
                if ( kind != 40 ) {
                    alert("unknown error, could not add this channel -- please contact a developer for help");
                }
                var isError = checkForChannelSubscriptionErrors( content );
                if ( isError ) {
                    alert("unknown error, could not add this channel -- please contact a developer for help");
                } else {
                    document.getElementsByClassName( "removable-channels" )[ 0 ].innerHTML += `
                            <div class="removable-channel ${event.id}">
                                <span class="x-circle" onclick="removeChannel( '${event.id}' )">&times;</span>
                                <span class="img-circle" style="background-image: url(${JSON.parse( content )[ "picture" ]})"></span>
                                <span class="removable-channel-name">${JSON.parse( content )[ "name" ]}</span>
                                <div style="clear: both"></div>
                            </div>
                    `;
                }
            }
            if ( kind == 40 ) {
                var isError = checkForChannelSubscriptionErrors( content );
                if ( isError ) {
                    alert("unknown error, could not add this channel -- please contact a developer for help");
                } else {
                    document.getElementsByClassName( "channels" )[ 0 ].firstElementChild.innerHTML += ( displayChannel( JSON.parse( content )[ "picture" ], JSON.parse( content )[ "name" ], "", event.id, event.created_at ) );
                    getLatestMessage( event.id );
                }
            }
            if (
                kind == 42
                && subId.includes( "add-messages" )
                ) {
                if ( document.getElementsByClassName( event.id )[ 0 ] ) return
                var isMine = ( event.pubkey == pubKey );
                if ( !isMine && !array_of_pubkeys.includes( event.pubkey ) ) {
                    array_of_pubkeys.push( event.pubkey );
                }
                var now = Math.floor( Date.now() / 1000 )
                var event_time = event.created_at
                var how_long_ago = convertHMS( now - event_time )
                var parent = "";
                var i; for ( i=0; i<event.tags.length; i++ ) {
                    if ( event[ "tags" ][ i ][ 0 ] == "e" && ( !parent || parent == "" ) ) {
                        parent = event[ "tags" ][ i ][ 1 ];
                    }
                }
                if ( !document.getElementsByClassName( parent )[ 0 ].classList.contains( "active" ) ) return
                var color = "";
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "e" || event.pubkey.substring( 0, 1 ) == "f" ) ) {
                    color = "red";
                }
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "c" || event.pubkey.substring( 0, 1 ) == "d" ) ) {
                    color = "pink";
                };
                if ( isNaN( event.pubkey.substring( 0, 1 ) ) && ( event.pubkey.substring( 0, 1 ) == "a" || event.pubkey.substring( 0, 1 ) == "b" ) ) {
                    color = "orange";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 10 ) {
                    color = "yellow";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 8 ) {
                    color = "green";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 6 ) {
                    color = "lightblue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 4 ) {
                    color = "blue";
                };
                if ( !isNaN( event.pubkey.substring( 0, 1 ) ) && event.pubkey.substring( 0, 1 ) < 2 ) {
                    color = "purple";
                };
                var name = event.pubkey.substring( 0, 15 ) + "...";
                if ( event.pubkey in namemap && namemap[ event.pubkey ] != "none" ) {
                    name = namemap[ event.pubkey ];
                }
                if ( isMine ) {
                    var html = `
                        <div data-author="${event.pubkey}" class="message me ${event.id}">
                            <div class="bubble">${content}</div>
                            <div data-timestamp="${event_time}" class="time">${how_long_ago}</div>
                        </div>
                    `;
                } else {
                    var html = `
                        <div class="message ${event.id}">
                            <div class="bubble"><div class="author ${color} ${event.pubkey}">${name}</div>${content}</div>
                            <div data-timestamp="${event_time}" class="time">${how_long_ago}</div>
                        </div>
                    `;
                }
                document.getElementsByClassName( "message-content" )[ 0 ].innerHTML += html;
                document.getElementsByClassName( "message-content" )[ 0 ].scrollTop = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;
                document.getElementsByClassName( "message-form" )[ 0 ].scrollIntoView();
                if ( document.getElementsByClassName( "message-header" )[ 0 ] ) {
                    document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                    document.getElementsByClassName( "message-header" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                }
                if ( window.innerWidth < 601 ) {
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].setAttribute( "data-timestamp", event_time );
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].getElementsByClassName( "time" )[ 0 ].innerText = how_long_ago;
                }
                document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestamp", event_time );
                document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestring", how_long_ago );
            }
            if (
                kind == 42
                && subId.includes( "latest-message" )
                ) {
                var now = Math.floor( Date.now() / 1000 )
                var event_time = event.created_at
                var how_long_ago = convertHMS( now - event_time )
                var parent = "";
                var i; for ( i=0; i<event.tags.length; i++ ) {
                    if ( event[ "tags" ][ i ][ 0 ] == "e" ) {
                        parent = event[ "tags" ][ i ][ 1 ];
                    }
                }
                var shortened_content = content.replace( /\n/g, " " ).substring( 0, 50 );
                if ( content.length > 50 ) {
                    shortened_content = shortened_content + "...";
                }
                document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].innerText = shortened_content;
                document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestring", how_long_ago )
                document.getElementsByClassName( parent )[ 0 ].getElementsByClassName( "message" )[ 0 ].setAttribute( "data-timestamp", event_time )
            }
            if (kind === 4) {
                content = await decrypt(privKey, pubKey, content)
            }
        })
        var subId   = bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" )
        var filter  = { "ids": subscribed_channels }

        socket.addEventListener('open', async function( e ) {
              
            var subscription = [ "REQ", subId, filter ]

            socket.send(JSON.stringify( subscription ));
            var event = {
                "content"    : "this workshop is awesome!",
                "created_at" : Math.floor( Date.now() / 1000 ),
                "kind"       : 1,
                "tags"       : [],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent(event, privKey)
            //socket.send(JSON.stringify([ "EVENT", signedEvent ]))
            var message   = "this message is super secret!"
            var encrypted = encrypt( privKey, pubKey, message )
            var event2 = {
                "content"    : encrypted,
                "created_at" : Math.floor( Date.now() / 1000 ),
                "kind"       : 4,
                "tags"       : [ [ 'p', pubKey ] ],
                "pubkey"     : pubKey,
            }
            var signedEvent2 = await getSignedEvent(event2, privKey)
            //socket.send(JSON.stringify([ "EVENT", signedEvent2 ]))
        })
        async function getSignedEvent(event, privateKey) {
            var eventData = JSON.stringify([
                0,                    // Reserved for future use
                event['pubkey'],        // The sender's public key
                event['created_at'],    // Unix timestamp
                event['kind'],        // Message “kind” or type
                event['tags'],        // Tags identify replies/recipients
                event['content']        // Your note contents
            ])
            event.id  = sha256( eventData ).toString( 'hex' )
            event.sig = await schnorr.sign( event.id, privateKey ) 
            return event
        }
        function hexToBytes( hex ) {
            return Uint8Array.from( hex.match( /.{1,2}/g ).map( ( byte ) => parseInt( byte, 16 ) ) );
        }

        function bytesToHex( bytes ) {
            return bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, '0' ), '' );
        }
        function base64ToHex( str ) {
            var raw = atob( str );
            var result = '';
            var i; for ( i=0; i<raw.length; i++ ) {
                var hex = raw.charCodeAt( i ).toString( 16 );
                result += ( hex.length === 2 ? hex : '0' + hex );
            }
            return result;
        }
        function encrypt( privkey, pubkey, text ) {
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var iv = window.crypto.getRandomValues(new Uint8Array(16));
            var cipher = browserifyCipher.createCipheriv( 'aes-256-cbc', hexToBytes( key ), iv );
            var encryptedMessage = cipher.update(text,"utf8","base64");
            emsg = encryptedMessage + cipher.final( "base64" );
            var uint8View = new Uint8Array( iv.buffer );
            var decoder = new TextDecoder();
            return emsg + "?iv=" + btoa( String.fromCharCode.apply( null, uint8View ) );
        }
        function decrypt( privkey, pubkey, ciphertext ) {
            var [ emsg, iv ] = ciphertext.split( "?iv=" );
            var key = nobleSecp256k1.getSharedSecret( privkey, '02' + pubkey, true ).substring( 2 );
            var decipher = browserifyCipher.createDecipheriv(
                'aes-256-cbc',
                hexToBytes( key ),
                hexToBytes( base64ToHex( iv ) )
            );
            var decryptedMessage = decipher.update( emsg, "base64" );
            dmsg = decryptedMessage + decipher.final( "utf8" );
            return dmsg;
        }
    </script>
    <script>
        function displayChannel( image, name, message, id, timestamp ) {
            var html = `
                        <li class="channel-outer ${id}" data-id="${id}" data-img="${image}" onclick="selectChannel( this );">
                            <a href="#">
                                <span style="background-image: url(${image})"></span>
                                <div class="channel-inner">
                                    <div class="name">${name}</div>
                                    <div data-timestamp="${timestamp}" class="message">${message}</div>
                                </div>
                            </a>
                        </li>
            `;
            return html;
        }
    </script>
    <script>
        function selectChannel( channel ) {
            var i; for ( i=0; i<document.getElementsByClassName( "channel-outer" ).length; i++ ) {
                document.getElementsByClassName( "channel-outer" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( "manage-channels-outer" )[ 0 ].classList.remove( "active" );
            document.getElementsByClassName( channel.getAttribute( "data-id" ) )[ 0 ].classList.add( "active" );
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span style="background-image: url(${channel.getAttribute( "data-img" )})"></span>
                        <div class="channel-wrapper">
                            <div class="name">${channel.getElementsByClassName( "name" )[ 0 ].innerText}</div>
                            <div data-timestamp="${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" )}" class="time">${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestring" )}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="info-circle">
                                <a href="#">
                                    <i class="fa fa-info-circle"></i>
                                </a>
                            </li>
                            <li class="hotdog">
                                <a href="#">
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="infobox">
                    <span class="infobox-text">Channel id: ${channel.getAttribute( "data-id" )}</span>
                    <span class="infobox-x">&times;</span>
                </div>
                <div class="message-content">
                </div>
                <div class="message-form">
                    <ul>
                        <li class="emoji-btn">
                            <a href="#">
                                <i class="fa fa-laugh"></i>
                            </a>
                        </li>
                        <li class="input">
                            <textarea class="note-input" rows="1" cols="70" type="text" placeholder="Say something"></textarea>
                        </li>
                        <li class="send-btn">
                            <a href="#">
                                <i class="fa fa-paper-plane"></i>
                            </a>
                        </li>
                        <li class="sound-btn">
                            <a href="#">
                                <i class="fa fa-microphone"></i>
                            </a>
                        </li>
                        <li class="image-btn">
                            <a href="#">
                                <i class="fa fa-image"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span style="background-image: url(${channel.getAttribute( "data-img" )})"></span>
                        <div class="channel-wrapper">
                            <div class="name">${channel.getElementsByClassName( "name" )[ 0 ].innerText}</div>
                            <div data-timestamp="${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestamp" )}" class="time">${channel.getElementsByClassName( "message" )[ 0 ].getAttribute( "data-timestring" )}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="info-circle">
                                <a href="#">
                                    <i class="fa fa-info-circle"></i>
                                </a>
                            </li>
                            <li class="hotdog">
                                <a href="#">
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="infobox">
                    Channel id: ${channel.getAttribute( "data-id" )}
                    <span class="infobox-x">&times;</span>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "block";
                document.getElementsByClassName( "message-content" )[ 0 ].scrollTop = document.getElementsByClassName( "message-content" )[ 0 ].scrollHeight;
                document.getElementsByClassName( "message-form" )[ 0 ].scrollIntoView();
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "info-circle" )[ 0 ].addEventListener( "click", function() {
                document.getElementsByClassName( "infobox" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "infobox-x" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "infobox" )[ 0 ].style.display = "none";
                })
            });
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.addEventListener( 'keypress', function ( e ) {
                if ( e.key === 'Enter' && !isShiftDown() ) {
                  sendNote();
                }
            });
            document.getElementsByClassName( "send-btn" )[ 0 ].addEventListener( 'click', function ( e ) {
                sendNote();
            });
            addMessages( channel.getAttribute( "data-id" ) );
        }
    </script>
    <script>
        function addMessages( id ) {
            var subId   = "add-messages" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 20 );
            var filter  = {
                "kinds": [ 42 ],
                "#e": [id]
            }
            var subscription = [ "REQ", subId, filter ]
            socket.send(JSON.stringify( subscription ));
        }
    </script>
    <script>
        function getLatestMessage( id ) {
            var subId   = "latest-message" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 0, 20 );
            var filter  = {
                "kinds": [ 42 ],
                "#e": [id],
                "limit": 1
            }
            var subscription = [ "REQ", subId, filter ]
            socket.send(JSON.stringify( subscription ));
        }
    </script>
    <script>
        async function sendNote() {
            var note = document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value;
            if ( !note || note == "" ) return;
            var id = document.getElementsByClassName( "channel-outer active" )[ 0 ].getAttribute( "data-id" );
            var event = {
                "content"    : note,
                "created_at" : Math.floor( Date.now() / 1000 ),
                "kind"       : 42,
                "tags"       : [["e", id]],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent(event, privKey);
            socket.send(JSON.stringify([ "EVENT", signedEvent ]))
            document.getElementsByClassName( "input" )[ 0 ].firstElementChild.value = "";
        }
    </script>
    <script>
        function convertHMS(value) {
            const sec = parseInt(value, 10); // convert value to number if it's string
            let years   = Math.floor(sec / 31536000); // get years
            let months  = Math.floor((sec - (years * 31536000)) / 2592000); // get months
            let days    = Math.floor((sec - (years * 31536000) - (months * 2592000)) / 86400); // get days
            let hours   = Math.floor((sec - (years * 31536000) - (months * 2592000) - (days * 86400)) / 3600); // get hours
            let minutes = Math.floor((sec - (years * 31536000) - (months * 2592000) - (days * 86400) - (hours * 3600)) / 60); // get minutes
            let seconds = sec - (years * 31536000) - (months * 2592000) - (days * 86400) - (hours * 3600) - (minutes * 60); //  get seconds
            var yearsstring = (years > 1) ? "years":"year";
            var monthsstring = (months > 1) ? "months":"month";
            var daysstring = (days > 1) ? "days":"day";
            var hoursstring = (hours > 1) ? "hours":"hour";
            var minutesstring = (minutes > 1) ? "minutes":"minute";
            var secondsstring = (seconds > 1) ? "seconds":"second";
            if ( years > 0 ) {
                return years + " " + yearsstring + " ago";
            }
            if ( months > 0 ) {
                return months + " " + monthsstring + " ago";
            }
            if ( days > 0 ) {
                return days + " " + daysstring + " ago";
            }
            if ( hours > 0 ) {
                return hours + " " + hoursstring + " ago";
            }
            if ( minutes > 0 ) {
                return minutes + " " + minutesstring + " ago";
            }
            if ( seconds == 0 ) {
                return seconds + " seconds ago";
            }
            return seconds + " " + secondsstring + " ago";
        }
    </script>
    <script>
        function updateTimesAndNames() {
            array_of_pubkeys.forEach( function( item, index ) {
                setTimeout( function() {
                    if ( 1==1 ) {
                        getUserMeta( array_of_pubkeys[ 0 ] );
                    }
                    array_of_pubkeys.shift();
                }, index * 300 );
            })
            var i; for ( i=0; i<document.getElementsByClassName( "time" ).length; i++ ) {
                var now = Math.floor( Date.now() / 1000 )
                var event_time = document.getElementsByClassName( "time" )[ i ].getAttribute( "data-timestamp" )
                var how_long_ago = convertHMS( now - event_time )
                document.getElementsByClassName( "time" )[ i ].innerText = how_long_ago;
            }
            setTimeout( function() {updateTimesAndNames();}, 10000 );
        }
        updateTimesAndNames();
    </script>
    <script>
        function manageChannels() {
            var i; for ( i=0; i<document.getElementsByClassName( "channel-outer" ).length; i++ ) {
                document.getElementsByClassName( "channel-outer" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( "manage-channels-outer" )[ 0 ].classList.add( "active" );
            var channels_info = [];
            var i; for ( i=0; i<document.getElementsByClassName( "channel-outer" ).length; i++ ) {
                var obj = {}
                obj[ "id" ] = document.getElementsByClassName( "channel-outer" )[ i ].getAttribute( "data-id" );
                obj[ "img" ] = document.getElementsByClassName( "channel-outer" )[ i ].getAttribute( "data-img" );
                obj[ "name" ] = document.getElementsByClassName( "channel-outer" )[ i ].getElementsByClassName( "name" )[ 0 ].innerText;
                channels_info.push( obj );
            }
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span class="plus-circle fa fa-list-check"></span>
                        <div class="channel-wrapper">
                            <div class="name">Manage channels</div>
                            <div class="message">Find/create/remove channels</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a href="#">
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                    <h2>Add by channel id</h2>
                    <input class="add-channel-input" type="text" placeholder="channel id" />
                    <button class="add-channel-btn">Submit</button>
                    <h2 style="margin-top: 20px;">Remove a channel</h2>
                    <div class="removable-channels"></div>
                    <h2 style="margin-top: 20px;">Create a channel</h2>
                    <input class="create-channel-name" type="text" placeholder="channel name" />
                    <input class="create-channel-image" type="text" placeholder="channel image e.g. https://i.ibb.co/Q8X9cQL/bitcoin-chess.png" />
                    <p class="image-instructions">The image needs to be hosted externally (such as on imgur or imgbb) because I don't want to store a bunch of images</p>
                    <button class="create-channel-btn" onclick="createChannel()">Submit</button>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            channels_info.forEach( function( item ) {
                document.getElementsByClassName( "removable-channels" )[ 0 ].innerHTML += `
                        <div class="removable-channel ${item.id}">
                            <span class="x-circle" onclick="removeChannel( '${item.id}' )">&times;</span>
                            <span class="img-circle" style="background-image: url(${item.img})"></span>
                            <span class="removable-channel-name">${item.name}</span>
                            <div style="clear: both"></div>
                        </div>
                `;
            })
            document.getElementsByClassName( "message-content" )[ 0 ].style.display = "block";
            document.getElementsByClassName( "message-content" )[ 0 ].style.flexDirection = "initial";
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span class="plus-circle fa fa-list-check"></span>
                        <div class="channel-wrapper">
                            <div class="name">Manage channels</div>
                            <div class="message">Find/create/remove channels</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a href="#">
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header" )[ 0 ].remove();
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "add-channel-btn" )[ 0 ].addEventListener( 'click', function ( e ) {
                var channel_id = document.getElementsByClassName( "add-channel-input" )[ 0 ].value;
                if ( channel_id && channel_id != "" ) {addChannel( channel_id );}
            });
            document.getElementsByClassName( "add-channel-input" )[ 0 ].addEventListener( 'keypress', function ( e ) {
                if ( e.key === 'Enter' ) {
                    var channel_id = document.getElementsByClassName( "add-channel-input" )[ 0 ].value;
                    if ( channel_id && channel_id != "" ) {addChannel( channel_id );}
                }
            });
        }
    </script>
    <script>
        async function showSettings() {
            var i; for ( i=0; i<document.getElementsByClassName( "channel-outer" ).length; i++ ) {
                document.getElementsByClassName( "channel-outer" )[ i ].classList.remove( "active" );
            }
            document.getElementsByClassName( "manage-channels-outer" )[ 0 ].classList.remove( "active" );
            var html = `
                <div class="message-header">
                    <div class="channel-info">
                        <span class="plus-circle fa fa-sliders"></span>
                        <div class="channel-wrapper">
                            <div class="name">Settings</div>
                            <div class="message">Modify all the things</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a href="#">
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="message-content">
                    <h2>Your public key</h2>
                    <input class="public-key" type="text" value="${pubKey}" disabled/>
                    <button class="copy-pubkey-btn">Copy</button>
                    <h2 style="margin-top: 20px;">Your private key</h2>
                    <input class="private-key" type="text" value="${privKey}" disabled/>
                    <button class="copy-privkey-btn">Copy</button>
                    <h2 style="margin-top: 20px;">Import an account</h2>
                    <input class="import-privkey-input" type="text" placeholder="paste a private key" />
                    <button class="import-privkey-btn">Import</button>
                </div>
            `;
            document.getElementsByClassName( "content" )[ 0 ].innerHTML = html;
            document.getElementsByClassName( "message-content" )[ 0 ].style.display = "block";
            document.getElementsByClassName( "message-content" )[ 0 ].style.flexDirection = "initial";
            if ( window.innerWidth < 601 ) {
                var html2 = `
                    <span class="sidebar_arrow">&rsaquo;</span>
                    <div class="channel-info">
                        <span class="plus-circle fa fa-list-check"></span>
                        <div class="channel-wrapper">
                            <div class="name">Manage channels</div>
                            <div class="message">Find/create/remove channels</div>
                        </div>
                    </div>
                    <div class="actions">
                        <ul>
                            <li class="hotdog">
                                <a href="#">
                                    <i class="fa fa-ellipsis-v"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                `;
                document.getElementsByClassName( "message-header-alt" )[ 0 ].innerHTML = html2;
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.width = "100%";
                document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "flex";
                document.getElementsByClassName( "message-header-alt" )[ 0 ].style.width = window.innerWidth - 38 + "px";
            }
            if ( window.innerWidth < 601 ) {
                document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "none";
                document.getElementsByClassName( "content" )[ 0 ].style.display = "flex";
            }
            if ( document.getElementsByClassName( "sidebar_arrow" )[ 0 ] ) {
                document.getElementsByClassName( "sidebar_arrow" )[ 0 ].addEventListener( "click", function() {
                    document.getElementsByClassName( "sidebar" )[ 0 ].style.display = "block";
                    document.getElementsByClassName( "content" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-hinder" )[ 0 ].style.display = "none";
                    document.getElementsByClassName( "message-header-alt" )[ 0 ].style.display = "none";
                })
            }
            document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
                showSettings();
            });
            document.getElementsByClassName( "copy-pubkey-btn" )[ 0 ].addEventListener( "click", function() {
                copyText( document.getElementsByClassName( "public-key" )[ 0 ] );
            });
            document.getElementsByClassName( "copy-privkey-btn" )[ 0 ].addEventListener( "click", function() {
                copyText( document.getElementsByClassName( "private-key" )[ 0 ] );
            });
            document.getElementsByClassName( "import-privkey-btn" )[ 0 ].addEventListener( "click", function() {
                importPrivkey( document.getElementsByClassName( "import-privkey-input" )[ 0 ].value );
            });
        }
    </script>
    <script>
        function addChannel( id ) {
            document.getElementsByClassName( "add-channel-input" )[ 0 ].value = "";
            if ( document.getElementsByClassName( id )[ 0 ] ) return
            subscribed_channels.push( id );
            var newsubId   = "00000000" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 )
            var newfilter  = { "ids": [ id ] }
            var newsubscription = [ "REQ", newsubId, newfilter ]
            socket.send(JSON.stringify( newsubscription ));
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
        }
    </script>
    <script>
        function removeChannel( id ) {
            var i; for ( i=0; i<document.getElementsByClassName( id ).length; i++ ) {
                document.getElementsByClassName( id )[ i ].remove();
                i = i - 1;
            }
            var i; for ( i=0; i<subscribed_channels.length; i++ ) {
                if ( subscribed_channels[ i ] == id ) {
                    subscribed_channels.pop( i );
                }
            }
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
        }
    </script>
    <script>
        async function createChannel() {
            var name = document.getElementsByClassName( "create-channel-name" )[ 0 ].value;
            var img = document.getElementsByClassName( "create-channel-image" )[ 0 ].value;
            if ( !name || name == "" ) return
            if ( !img || img == "" ) return
            if ( !img.startsWith( "https://" ) || ( !img.endsWith( ".png" ) && !img.endsWith( ".jpg" ) && !img.endsWith( ".jpeg" ) && !img.endsWith( ".gif" ) && !img.endsWith( ".webp" ) ) ) {
                    alert( "There was an error with your image url, it either did not begin with https:// or it did not end with .png, .jpg, .jpeg, .gif, or .webp" );
                    return;
                }
            document.getElementsByClassName( "create-channel-name" )[ 0 ].value = "";
            document.getElementsByClassName( "create-channel-image" )[ 0 ].value = "";
            var chan = {}
            chan[ "about" ] = "";
            chan[ "name" ] = name;
            chan[ "picture" ] = img;
            var note = JSON.stringify( chan );
            var event = {
                "content"    : note,
                "created_at" : Math.floor( Date.now() / 1000 ),
                "kind"       : 40,
                "tags"       : [],
                "pubkey"     : pubKey,
            }
            var signedEvent = await getSignedEvent(event, privKey);
            socket.send(JSON.stringify([ "EVENT", signedEvent ]))
            setTimeout( function() {addChannel( signedEvent.id );}, 1500 );
        }
    </script>
    <script>
        function checkForUserMetaErrors( content ) {
            try {  
                var json = JSON.parse( content );
            } catch ( e ) {  
                return true;  
            }
            return false;
        }
    </script>
    <script>
        function checkForChannelSubscriptionErrors( content ) {
            try {  
                var json = JSON.parse( content );
                if ( !( "picture" in json ) ) {
                    return true;
                }  
                if ( !( "name" in json ) ) {
                    return true;
                }
                if ( !json[ "picture" ].startsWith( "https://" ) || ( !json[ "picture" ].endsWith( ".png" ) && !json[ "picture" ].endsWith( ".jpg" ) && !json[ "picture" ].endsWith( ".jpeg" ) && !json[ "picture" ].endsWith( ".gif" ) && !json[ "picture" ].endsWith( ".webp" ) ) ) {
                    return true;
                }
            } catch ( e ) {  
                return true;  
            }
            return false;
        }
    </script>
    <script>
        function copyText( element ) {
            element.select();
            element.setSelectionRange( 0, 99999 );
            navigator.clipboard.writeText( element.value );
            alert( "copied! " + element.value );
        }
    </script>
    <script>
        function isHex(string) {
            var a = parseInt(string, 16)
            var padding = "000000000000";
            padding = padding + a.toString(16);
            final = padding.slice( -Math.abs( string.length ) )
            return final === string
        }
        function importPrivkey( privkey ) {
            if ( privkey.length != 64 ) {
                alert( "Your private key must be a 32 byte hex-formatted string" );
                return;
            }
            if ( !(
                isHex( privkey.substring( 0, 8 ) )
                && isHex( privkey.substring( 8, 16 ) )
                && isHex( privkey.substring( 16, 24 ) )
                && isHex( privkey.substring( 24, 32 ) )
                && isHex( privkey.substring( 32, 40 ) )
                && isHex( privkey.substring( 40, 48 ) )
                && isHex( privkey.substring( 48, 56 ) )
                && isHex( privkey.substring( 56, 64 ) )
                ) ) {
                alert( "your private key is not hex" );
                return;
            }
            var pubkey = nobleSecp256k1.getPublicKey( privkey, true )
            pubkey = pubkey.substring( 2 );
            privKey = privkey;
            pubKey = pubkey;
            document.getElementsByClassName( "public-key" )[ 0 ].value = pubKey;
            document.getElementsByClassName( "private-key" )[ 0 ].value = privKey;
            var stuff_to_backup = {}
            stuff_to_backup[ "privkey" ] = privKey;
            stuff_to_backup[ "pubkey" ] = pubKey;
            stuff_to_backup[ "channels" ] = JSON.stringify( subscribed_channels );
            stuff_to_backup[ "relays" ] = JSON.stringify( [ relay ] );
            localStorage[ "backup" ] = JSON.stringify( stuff_to_backup );
            alert( "success, your account has been imported" );
        }
    </script>
    <script>
        var keymap = {};
        onkeydown = onkeyup = function(e){
            e = e || event; // to deal with IE
            keymap[e.key] = e.type == 'keydown';
        }
        function isShiftDown() {
            if ( "Shift" in keymap ) {
                return keymap[ "Shift" ];
            }
            return false;
        }
    </script>
    <div class="chat">
        <div class="sidebar">
            <div class="search">
                <input type="text" placeholder="Search...">
                <i class="fa fa-search"></i>
            </div>
            <div class="channels">
                <ul>
                        <li class="manage-channels-outer" onclick="manageChannels();">
                            <a href="#">
                                <span class="plus-circle fa fa-list-check"></span>
                                <div class="manage-channels-inner">
                                    <div class="name">Manage channels</div>
                                    <div class="message">Find/create/remove channels</div>
                                </div>
                            </a>
                        </li>
                </ul>
            </div>
        </div>
        <div class="content">
            <div class="message-header">
                <div class="channel-info">
                    <span class="plus-circle">N</span>
                    <div class="channel-wrapper">
                        <div class="name">Nostrgram</div>
                        <div class="message">Talk to people</div>
                    </div>
                </div>
                <div class="actions">
                    <ul>
                        <li class="hotdog">
                            <a href="#">
                                <i class="fa fa-ellipsis-v"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="message-content">
                <div class="startup-message">
                    Please select a channel on the left. You can also go to Settings (three dots in the top right) to import a private key or backup your current keys.
                </div>
            </div>
        </div>
    </div>
    <div class="message-header-hinder">
    </div>
    <div class="message-header-alt">
    </div>
    <script>
        document.getElementsByClassName( "hotdog" )[ 0 ].addEventListener( "click", function() {
            showSettings();
        });
    </script>
    <script>
        function setNoteInputHeight() {
            if ( document.getElementsByClassName( "note-input" )[ 0 ] ) {
                document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";document.getElementsByClassName( "note-input" )[ 0 ].style.height = (document.getElementsByClassName( "note-input" )[ 0 ].scrollHeight)-1+"px";
                var text = document.getElementsByClassName( "note-input" )[ 0 ].value;
                var match = /\r|\n/.exec(text);
                if ( match || document.getElementsByClassName( "note-input" )[ 0 ].offsetHeight >= 40 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].style.lineHeight = "18px";
                    document.getElementsByClassName( "note-input" )[ 0 ].style.borderRadius = "10px";
                } else if ( document.getElementsByClassName( "note-input" )[ 0 ].offsetHeight < 34 ) {
                    document.getElementsByClassName( "note-input" )[ 0 ].style.lineHeight = "35px";
                    document.getElementsByClassName( "note-input" )[ 0 ].style.borderRadius = "36px";
                }
            }
            setTimeout( function() {setNoteInputHeight();}, 50 );
        }
        setNoteInputHeight();
    </script>
    <script>
        function getUserMeta( pubkey ) {
            if ( pubkey in namemap && namemap[ pubkey ] != "none" ) {
                var i; for ( i=0; i<document.getElementsByClassName( pubkey ).length; i++ ) {
                    document.getElementsByClassName( pubkey )[ i ].innerText = namemap[ pubkey ];
                }
            } else if ( !( pubkey in namemap ) ) {
                var newsubId   = "00000001" + bitcoinjs.ECPair.makeRandom().privateKey.toString( "hex" ).substring( 8 )
                var newfilter  = { "authors": [ pubkey ], "kinds": [0], "limit": 1 }
                var newsubmo = [ "REQ", newsubId, newfilter ]
                socket.send(JSON.stringify( newsubmo ));
            }
        }
    </script>
</body>

</html>
